<div class="profile-page">
  <div class="dashboard-container">
    <!-- Header Section -->
    <header class="dashboard-header">
      <div class="title-group">
        <h1 class="pixel-title">PILOT DASHBOARD</h1>
        <div class="system-status">
          <span class="status-dot"></span>
          SYSTEM ONLINE
        </div>
      </div>
      
      <div class="mini-profile">
        <span class="mini-name">{{ userProfile()?.display_name || 'GUEST' }}</span>
        <img [src]="userProfile()?.avatar_url || 'https://www.w3schools.com/howto/img_avatar.png'" 
             class="mini-avatar" 
             (error)="handleImageError($event)">
      </div>
    </header>

    <div class="dashboard-grid">
      <!-- Sidebar: Character Info -->
      <aside class="dashboard-sidebar">
        <div class="pixel-box character-card">
          <div class="avatar-wrapper">
            <img [src]="previewUrl || userProfile()?.avatar_url || 'https://www.w3schools.com/howto/img_avatar.png'" 
                 class="main-avatar" 
                 (error)="handleImageError($event)">
            
            <button class="pixel-btn edit-avatar-float" (click)="triggerFileInput()">
              <mat-icon>photo_camera</mat-icon>
            </button>
            <input type="file" id="fileInput" (change)="onAvatarChange($event)" style="display: none" accept="image/*">
          </div>

          <div class="character-identity">
            <h2 class="display-name">{{ userProfile()?.display_name || 'UNNAMED PILOT' }}</h2>
            <div class="level-badge">LEVEL {{ userProfile()?.level || 1 }}</div>
          </div>

          <div class="quick-edit">
            <input type="text" 
                   [(ngModel)]="newNickname" 
                   placeholder="Update nickname..." 
                   class="pixel-input"
                   (keyup.enter)="createOrUpdateProfile()">
            <button class="pixel-btn btn-save" (click)="createOrUpdateProfile()" [disabled]="uploading()">
              <mat-icon>{{ uploading() ? 'hourglass_empty' : 'save' }}</mat-icon>
            </button>
          </div>

          @if (uploadMessage()) {
            <div class="message" [class.error]="uploadMessage()?.includes('Error')">
              {{ uploadMessage() }}
            </div>
          }
        </div>

        <div class="pixel-box session-card">
          <button class="pixel-btn btn-secondary" routerLink="/mission">
            <mat-icon>assignment</mat-icon> VIEW MISSIONS
          </button>
          <button class="pixel-btn btn-danger" (click)="logout()">
            <mat-icon>logout</mat-icon> DISCONNECT
          </button>
        </div>
      </aside>

      <!-- Main Content: Stats & Credentials -->
      <main class="dashboard-main">
        <!-- Credentials Section -->
        <section class="pixel-box section-card">
          <div class="section-header">
            <mat-icon>badge</mat-icon>
            <h3>PILOT CREDENTIALS</h3>
          </div>
          <div class="credentials-grid">
            <div class="credential-item">
              <span class="label">UNIQUE IDENTIFIER</span>
              <span class="value code">{{ currentUser()?.uid }}</span>
            </div>
            <div class="credential-item">
              <span class="label">COMMUNICATION LINK</span>
              <span class="value">{{ currentUser()?.email }}</span>
            </div>
            <div class="credential-item">
              <span class="label">RECRUITMENT DATE</span>
              <span class="value">{{ formatDate(currentUser()?.metadata?.creationTime) }}</span>
            </div>
          </div>
        </section>

        <!-- Stats Section -->
        <section class="pixel-box section-card stats-container">
          <div class="section-header">
            <mat-icon>trending_up</mat-icon>
            <h3>MISSION PROGRESS</h3>
          </div>

          <div class="xp-bar-wrapper">
            <div class="xp-header">
              <span>EXPERIENCE POINTS</span>
              <span>{{ userProfile()?.xp || 0 }} XP</span>
            </div>
            <div class="pixel-progress-bg">
              <div class="pixel-progress-fill" [style.width.%]="(userProfile()?.xp || 0) % 100"></div>
            </div>
          </div>

          <div class="activity-log">
            <h4>RECENT TELEMETRY</h4>
            <div class="log-item">
              <span class="log-time">JUST NOW</span>
              <span class="log-event">Authorized secure connection</span>
            </div>
            <div class="log-item">
              <span class="log-time">SYSTEM</span>
              <span class="log-event">XP Telemetry updated</span>
            </div>
          </div>
        </section>
      </main>
    </div>
  </div>
</div>
