<div class="profile-container">
  @if (!userProfile()?.display_name) {
    <!-- CREATION MODE: User needs to set up profile first -->
    <div class="setup-card">
      <h2>ตั้งค่าโปรไฟล์ของคุณ</h2>
      <p class="subtitle">เพื่อเข้าสู่โลกของ The Convergence</p>
      
      <div class="avatar-upload-section">
        <div class="avatar-preview" (click)="triggerFileInput()">
          @if (previewUrl || userProfile()?.avatar_url) {
            <img [src]="previewUrl || userProfile()?.avatar_url" alt="Avatar Preview">
          } @else {
            <div class="placeholder">
              <span>+</span>
              <small>อัปโหลด</small>
            </div>
          }
        </div>
        <input type="file" id="fileInput" (change)="onAvatarChange($event)" accept="image/*" hidden>
        <button type="button" class="btn-secondary" (click)="triggerFileInput()">เปลี่ยนรูปโปรไฟล์</button>
      </div>

      <div class="form-group">
        <label>ชื่อเล่น (Nickname)</label>
        <input type="text" [(ngModel)]="newNickname" placeholder="ระบุชื่อที่ต้องการใช้ในระบบ...">
      </div>

      <div class="actions">
        <button class="btn-primary" [disabled]="uploading()" (click)="createOrUpdateProfile()">
          @if (uploading()) {
            กำลังบันทึก...
          } @else {
            สร้างโปรไฟล์และเริ่มต้น
          }
        </button>
      </div>
      
      @if (uploadMessage()) {
        <div class="message" [class.error]="uploadMessage()?.includes('Error') || uploadMessage()?.includes('ผิดพลาด')">
          {{ uploadMessage() }}
        </div>
      }
    </div>
  } @else {
    <!-- VIEW MODE: League of Legends Style -->
    <div class="league-profile-view">
      <div class="lp-header">
        <span class="app-name">THE CONVERGENCE</span>
        <div class="user-corner">
           <span class="uc-name">{{ userProfile()?.display_name }}</span>
           <img class="uc-avatar" [src]="userProfile()?.avatar_url || 'https://www.w3schools.com/howto/img_avatar.png'" (error)="handleImageError($event)">
        </div>
      </div>

      <div class="lp-main">
        <!-- Left Column: Big Avatar & Status -->
        <div class="lp-left-col">
           <div class="lp-big-avatar-container">
              <div class="lp-big-avatar">
                 <img [src]="userProfile()?.avatar_url || 'https://www.w3schools.com/howto/img_avatar.png'" alt="Avatar" (error)="handleImageError($event)">
              </div>
              <button class="edit-avatar-btn" (click)="triggerFileInput()" title="เปลี่ยนรูปโปรไฟล์">
                ✎
              </button>
              <input type="file" id="fileInput" (change)="onAvatarChange($event)" accept="image/*" style="display: none;">
           </div>
           
           <div class="lp-username-big">
              {{ userProfile()?.display_name }}
           </div>
           
           <div class="lp-level-badge">
             Level {{ userProfile()?.level || 1 }}
           </div>

           <div class="lp-status">
              <span class="status-dot"></span> Active Member
           </div>

           <!-- Edit Nickname quick input (optional, keeps UI clean if hidden, but useful) -->
           <div class="edit-name-section">
             <input type="text" [(ngModel)]="newNickname" placeholder="เปลี่ยนชื่อเล่น..." class="lp-input">
             <button class="btn-save-small" (click)="createOrUpdateProfile()" [disabled]="uploading()">บันทึก</button>
           </div>
           @if (uploadMessage()) {
              <div class="mini-msg">{{ uploadMessage() }}</div>
           }
        </div>

        <!-- Right Column: Info & Stats -->
        <div class="lp-right-col">
           <!-- Account Information Section -->
           <div class="lp-section">
              <h3>ข้อมูลบัญชี (Account Information)</h3>
              <div class="lp-grid">
                 <div class="lp-grid-item">
                    <label>DISPLAY NAME</label>
                    <div class="value">{{ userProfile()?.display_name }}</div>
                 </div>
                 <div class="lp-grid-item">
                    <label>USER ID</label>
                    <div class="value token">{{ currentUser()?.uid }}</div>
                 </div>
                 <div class="lp-grid-item">
                    <label>EMAIL</label>
                    <div class="value">{{ currentUser()?.email }}</div>
                 </div>
                 <div class="lp-grid-item">
                    <label>MEMBER SINCE</label>
                    <div class="value">{{ formatDate(userProfile()?.createdAt) }}</div>
                 </div>
              </div>
           </div>

           <!-- Activity Section -->
           <div class="lp-section">
              <h3>กิจกรรม (Activity)</h3>
              <div class="activity-timeline">
                 <div class="activity-item">
                    <div class="activity-line"></div>
                    <div class="activity-content">
                       <span class="activity-date">Today</span>
                       <p>เข้าสู่ระบบสำเร็จ (Logged in)</p>
                    </div>
                 </div>
                 <div class="activity-item">
                    <div class="activity-line"></div>
                    <div class="activity-content">
                       <span class="activity-date">XP Progress</span>
                       <p>Current XP: {{ userProfile()?.xp || 0 }}</p>
                    </div>
                 </div>
              </div>
           </div>
           
           <div class="lp-actions">
              <button class="btn-back" routerLink="/home">กลับหน้าหลัก (Home)</button>
              <button class="btn-logout" (click)="auth.logout()">ออกจากระบบ (Logout)</button>
           </div>
        </div>
      </div>
    </div>
  }
</div>